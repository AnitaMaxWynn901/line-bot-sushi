<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sushi Menu</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="stylesheet" href="liff-app.css">
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üç£ Sushi Menu</h1>
      <p>Welcome to our restaurant!</p>
    </div>

    <div class="user-info" id="userInfo">
      <p>Loading user info...</p>
    </div>

    <!-- Membership Card (hidden initially) -->
    <div class="card" id="membershipCard" style="display: none;">
      <h3>üåü Membership Program</h3>
      <p>Join our membership to earn points and get exclusive rewards!</p>
      <button class="btn btn-primary" onclick="showRegistrationForm()">Become a Member</button>
    </div>

    <!-- Registration Form (hidden initially) -->
    <div class="card" id="registrationForm" style="display: none;">
      <h3>üìù Member Registration</h3>
      <p>Please provide your information:</p>
      <input type="tel" id="phone" placeholder="Phone Number *" class="input-field">
      <input type="email" id="email" placeholder="Email (optional)" class="input-field">
      <button class="btn btn-primary" onclick="registerMember()">Register</button>
      <button class="btn btn-secondary" onclick="cancelRegistration()">Cancel</button>
    </div>

    <div class="menu-item">
      <div>
        <h3>üç£ Salmon Sushi</h3>
        <p>Fresh Norwegian salmon</p>
      </div>
      <div class="price">$12</div>
    </div>

    <div class="menu-item">
      <div>
        <h3>üç£ Tuna Sushi</h3>
        <p>Premium bluefin tuna</p>
      </div>
      <div class="price">$15</div>
    </div>

    <div class="menu-item">
      <div>
        <h3>üç£ Unagi Sushi</h3>
        <p>Grilled freshwater eel</p>
      </div>
      <div class="price">$18</div>
    </div>

    <button class="btn" onclick="sendMessage()">Order Now</button>
    <button class="btn" onclick="closeLIFF()">Close</button>
  </div>

  <script>
    // ===== WAIT FOR EVERYTHING TO LOAD =====
    (async function () {
      // Step 1: Wait for page to be ready
      if (document.readyState === 'loading') {
        await new Promise(resolve => {
          document.addEventListener('DOMContentLoaded', resolve);
        });
      }

      // Step 2: Wait for Supabase SDK to load
      let supabaseWaitCount = 0;
      while (typeof window.supabase === 'undefined' && supabaseWaitCount < 50) {
        await new Promise(resolve => setTimeout(resolve, 100)); // Wait 100ms
        supabaseWaitCount++;
      }

      if (typeof window.supabase === 'undefined') {
        console.error('‚ùå Supabase SDK failed to load');
        document.getElementById('userInfo').innerHTML =
          '<p style="color: red;">Error: Supabase SDK not loaded</p>';
        return;
      }

      console.log('‚úÖ Supabase SDK loaded');

      // Step 3: Wait for LIFF SDK to load
      let liffWaitCount = 0;
      while (typeof liff === 'undefined' && liffWaitCount < 50) {
        await new Promise(resolve => setTimeout(resolve, 100)); // Wait 100ms
        liffWaitCount++;
      }

      if (typeof liff === 'undefined') {
        console.error('‚ùå LIFF SDK failed to load');
        document.getElementById('userInfo').innerHTML =
          '<p style="color: red;">Error: LIFF SDK not loaded</p>';
        return;
      }

      console.log('‚úÖ LIFF SDK loaded');

      // Step 4: NOW create Supabase client (after SDK is loaded!)
      const SUPABASE_URL = 'https://rrppsqmcunaeouijzrly.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJycHBzcW1jdW5hZW91aWp6cmx5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNzYzMTEsImV4cCI6MjA4Mzc1MjMxMX0.oOh5Dox4S4k9nRjDGMYi1iFUbGSjsnx8_Fgd7n1EE-8';

      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('‚úÖ Supabase client created');

      // Step 5: Initialize LIFF
      try {
        console.log('üîÑ Initializing LIFF...');
        await liff.init({ liffId: '2008845366-HByFMhkn' });
        console.log('‚úÖ LIFF initialized');

        if (liff.isLoggedIn()) {
          console.log('‚úÖ User is logged in');
          await getUserProfile();
        } else {
          console.log('‚ö†Ô∏è User not logged in, redirecting...');
          liff.login();
        }
      } catch (err) {
        console.error('‚ùå LIFF error:', err);
        document.getElementById('userInfo').innerHTML =
          '<p style="color: red;">LIFF Error: ' + err.message + '</p>';
      }

      // ===== FUNCTIONS =====
      async function getUserProfile() {
        try {
          console.log('üîÑ Getting profile...');
          const profile = await liff.getProfile();
          console.log('‚úÖ Profile loaded:', profile);

          document.getElementById('userInfo').innerHTML = `
          <img src="${profile.pictureUrl}" alt="Profile">
          <h3>Hello, ${profile.displayName}! üëã</h3>
          <p>Welcome to our sushi restaurant</p>
          <p style="font-size: 12px; color: #999;">User ID: ${profile.userId}</p>
        `;
          await checkMembershipStatus(profile.userId);
          // NOW you can use Supabase here to check if user is registered
          console.log('Supabase is ready to use!');
        } catch (err) {
          console.error('‚ùå Profile error:', err);
          document.getElementById('userInfo').innerHTML =
            '<p style="color: red;">Error: ' + err.message + '</p>';
        }
      }

      // Make functions available globally for onclick handlers
      window.sendMessage = function () {
        liff.sendMessages([{
          type: 'text',
          text: 'I want to make an order! üç£'
        }])
          .then(() => alert('Message sent!'))
          .catch((error) => alert('Error: ' + error.message));
      };

      window.closeLIFF = function () {
        liff.closeWindow();
      };

      // ===== MEMBERSHIP DATABASE FUNCTIONS =====

      async function checkMembershipStatus(userId) {
        try {
          console.log('üîç Checking membership for:', userId);

          const { data, error } = await supabase
            .from('members')
            .select('*')
            .eq('line_user_id', userId)
            .single();

          if (error || !data) {
            // User is NOT a member - show registration option
            console.log('‚ùå Not a member yet');
            document.getElementById('membershipCard').style.display = 'block';
          } else {
            // User IS a member - show member card
            console.log('‚úÖ User is a member:', data);
            showMemberCard(data);
          }
        } catch (err) {
          console.log('Membership check error:', err);
          // Show registration option anyway
          document.getElementById('membershipCard').style.display = 'block';
        }
      }

      function showMemberCard(memberData) {
        document.getElementById('membershipCard').innerHTML = `
        <h3>‚≠ê Member Card</h3>
        <p><strong>Name:</strong> ${memberData.display_name}</p>
        <p><strong>Phone:</strong> ${memberData.phone}</p>
        <p><strong>Points:</strong> ${memberData.points} pts</p>
        <p style="font-size: 12px; color: #999;">Member since: ${new Date(memberData.created_at).toLocaleDateString()}</p>
      `;
        document.getElementById('membershipCard').style.display = 'block';
      }
      // Show registration form
      window.showRegistrationForm = function () {
        document.getElementById('membershipCard').style.display = 'none';
        document.getElementById('registrationForm').style.display = 'block';
      };

      // Cancel registration
      window.cancelRegistration = function () {
        document.getElementById('registrationForm').style.display = 'none';
        document.getElementById('membershipCard').style.display = 'block';
      };

      // Register member (placeholder for now)
      // Register member - SAVE TO DATABASE
      window.registerMember = async function () {
        // Get form values
        const phone = document.getElementById('phone').value.trim();
        const email = document.getElementById('email').value.trim();

        // Validation - phone is required
        if (!phone) {
          alert('‚ùå Please enter your phone number');
          return;
        }

        if (phone.length < 10) {
          alert('‚ùå Please enter a valid phone number (at least 10 digits)');
          return;
        }

        try {
          // Get user profile from LIFF
          const profile = await liff.getProfile();

          console.log('üìù Registering member:', {
            userId: profile.userId,
            name: profile.displayName,
            phone: phone,
            email: email
          });

          // Insert into Supabase database
          const { data, error } = await supabase
            .from('members')
            .insert([
              {
                line_user_id: profile.userId,
                display_name: profile.displayName,
                phone: phone,
                email: email || null,
                points: 0
              }
            ])
            .select();

          if (error) {
            console.error('‚ùå Registration error:', error);
            alert('‚ùå Registration failed: ' + error.message);
            return;
          }

          console.log('‚úÖ Registration successful:', data);

          // Show success message
          alert('üéâ Welcome! You are now a member!');

          // Hide registration form
          document.getElementById('registrationForm').style.display = 'none';

          // Show member card with new data
          showMemberCard(data[0]);

          // Clear form
          document.getElementById('phone').value = '';
          document.getElementById('email').value = '';

        } catch (err) {
          console.error('‚ùå Error:', err);
          alert('‚ùå Something went wrong. Please try again.');
        }
      };
    })();
  </script>
</body>

</html>