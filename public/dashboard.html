<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Member Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      color: #333;
      font-size: 28px;
      margin-bottom: 10px;
    }

    .header p {
      color: #666;
      font-size: 14px;
    }

    .profile-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .profile-card img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin-bottom: 15px;
      border: 3px solid #667eea;
    }

    .profile-card h2 {
      color: #333;
      font-size: 24px;
      margin-bottom: 10px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-box {
      background: white;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .stat-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      color: #999;
    }

    .info-card {
      background: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      color: #999;
      font-size: 14px;
    }

    .info-value {
      color: #333;
      font-weight: bold;
      text-align: right;
    }

    .reward-card {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      text-align: center;
      color: white;
    }

    .reward-card h3 {
      font-size: 20px;
      margin-bottom: 10px;
    }

    .reward-card p {
      font-size: 14px;
      opacity: 0.9;
    }

    .btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 25px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }

    .btn:hover {
      background: #5568d3;
    }

    .loading {
      text-align: center;
      padding: 50px;
      color: white;
      font-size: 18px;
    }

    .error {
      background: #ff4444;
      color: white;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 20px;
    }

    .debug {
      background: #333;
      color: #0f0;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-size: 12px;
      font-family: monospace;
      max-height: 200px;
      overflow-y: auto;
    }

    .progress-bar {
      background: #eee;
      border-radius: 10px;
      height: 20px;
      margin-top: 10px;
      overflow: hidden;
    }

    .progress-fill {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      height: 100%;
      transition: width 0.3s ease;
    }

    .points-badge {
      background: #667eea;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 18px;
      font-weight: bold;
      display: inline-block;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üìä Member Dashboard</h1>
      <p>Your complete membership overview</p>
    </div>

    <!-- DEBUG OUTPUT -->
    <div class="debug" id="debugLog">
      üîç Debug Log:<br>
      Initializing...
    </div>

    <div id="loadingMessage" class="loading">
      Loading your dashboard...
    </div>

    <div id="dashboardContent" style="display: none;">
      <!-- Profile Card -->
      <div class="profile-card" id="profileCard">
        <!-- Will be filled by JavaScript -->
      </div>

      <!-- Stats Grid -->
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-icon">üíé</div>
          <div class="stat-value" id="totalPoints">0</div>
          <div class="stat-label">Total Points</div>
        </div>
        <div class="stat-box">
          <div class="stat-icon">üéØ</div>
          <div class="stat-value" id="pointsToReward">0</div>
          <div class="stat-label">To Next Reward</div>
        </div>
      </div>

      <!-- Rewards Progress -->
      <div class="reward-card">
        <h3>üéÅ Rewards Progress</h3>
        <p id="rewardMessage">Keep earning points!</p>
        <div class="progress-bar">
          <div class="progress-fill" id="progressBar"></div>
        </div>
      </div>

      <!-- Member Info -->
      <div class="info-card">
        <h3 style="margin-bottom: 15px; color: #333;">üìã Member Information</h3>
        <div class="info-row">
          <span class="info-label">üì± Phone</span>
          <span class="info-value" id="memberPhone">-</span>
        </div>
        <div class="info-row" id="emailRow" style="display: none;">
          <span class="info-label">üìß Email</span>
          <span class="info-value" id="memberEmail">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">üìÖ Member Since</span>
          <span class="info-value" id="memberSince">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">üÜî User ID</span>
          <span class="info-value" id="userId" style="font-size: 10px;">-</span>
        </div>
      </div>

      <!-- Action Buttons -->
      <button class="btn" onclick="openMenu()">üç£ Order Now</button>
      <button class="btn" onclick="closeLIFF()" style="background: #6c757d;">Close</button>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://rrppsqmcunaeouijzrly.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJycHBzcW1jdW5hZW91aWp6cmx5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNzYzMTEsImV4cCI6MjA4Mzc1MjMxMX0.oOh5Dox4S4k9nRjDGMYi1iFUbGSjsnx8_Fgd7n1EE-8';

    let supabase;
    let userProfile;
    
    // Debug logging function
    function debugLog(message) {
      const debugDiv = document.getElementById('debugLog');
      debugDiv.innerHTML += '<br>' + message;
      console.log(message);
      debugDiv.scrollTop = debugDiv.scrollHeight;
    }

    (async function () {
      try {
        debugLog('‚úÖ Script started');
        
        // Wait for Supabase SDK
        debugLog('‚è≥ Waiting for Supabase SDK...');
        let supabaseWait = 0;
        while (typeof window.supabase === 'undefined' && supabaseWait < 50) {
          await new Promise(resolve => setTimeout(resolve, 100));
          supabaseWait++;
        }
        
        if (typeof window.supabase === 'undefined') {
          debugLog('‚ùå Supabase SDK failed to load');
          showError('Supabase SDK not loaded');
          return;
        }
        
        debugLog('‚úÖ Supabase SDK loaded');
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        debugLog('‚úÖ Supabase client created');

        // Wait for LIFF SDK
        debugLog('‚è≥ Waiting for LIFF SDK...');
        let liffWait = 0;
        while (typeof liff === 'undefined' && liffWait < 50) {
          await new Promise(resolve => setTimeout(resolve, 100));
          liffWait++;
        }
        
        if (typeof liff === 'undefined') {
          debugLog('‚ùå LIFF SDK failed to load');
          showError('LIFF SDK not loaded');
          return;
        }
        
        debugLog('‚úÖ LIFF SDK loaded');

        // Initialize LIFF
        debugLog('‚è≥ Initializing LIFF with ID: 2008845366-m8PxiFt0');
        await liff.init({ liffId: '2008845366-m8PxiFt0' });
        debugLog('‚úÖ LIFF initialized');

        if (liff.isLoggedIn()) {
          debugLog('‚úÖ User is logged in');
          userProfile = await liff.getProfile();
          debugLog('‚úÖ Profile loaded: ' + userProfile.displayName);
          debugLog('üë§ User ID: ' + userProfile.userId.substring(0, 20) + '...');
          await loadDashboard();
        } else {
          debugLog('‚ö†Ô∏è User not logged in, redirecting to login...');
          liff.login();
        }
      } catch (err) {
        debugLog('‚ùå ERROR: ' + err.message);
        console.error('Full error:', err);
        showError('Failed to load dashboard: ' + err.message);
      }
    })();

    async function loadDashboard() {
      try {
        debugLog('üìä Loading dashboard for: ' + userProfile.userId);

        // Fetch member data
        debugLog('‚è≥ Fetching member data from Supabase...');
        const { data: member, error } = await supabase
          .from('members')
          .select('*')
          .eq('line_user_id', userProfile.userId)
          .single();

        if (error) {
          debugLog('‚ùå Supabase error: ' + error.message);
          showError('Database error: ' + error.message);
          return;
        }

        if (!member) {
          debugLog('‚ùå Member not found in database');
          showError('Member not found. Please register first.');
          return;
        }

        debugLog('‚úÖ Member found: ' + member.display_name);
        debugLog('üíé Points: ' + member.points);

        // Display dashboard
        displayDashboard(member);

      } catch (err) {
        debugLog('‚ùå Dashboard error: ' + err.message);
        console.error('Dashboard error:', err);
        showError('Error loading dashboard');
      }
    }

    function displayDashboard(member) {
      debugLog('üé® Rendering dashboard...');
      
      // Hide loading
      document.getElementById('loadingMessage').style.display = 'none';
      document.getElementById('dashboardContent').style.display = 'block';

      // Profile Card
      document.getElementById('profileCard').innerHTML = `
        <img src="${userProfile.pictureUrl}" alt="Profile">
        <h2>Hello, ${member.display_name}! üëã</h2>
        <p style="color: #999; margin-top: 5px;">Welcome back to your dashboard</p>
        <div class="points-badge">üíé ${member.points} Points</div>
      `;

      // Stats
      document.getElementById('totalPoints').textContent = member.points;

      // Calculate points to next reward (every 50 points = 1 reward)
      const pointsToNext = 50 - (member.points % 50);
      document.getElementById('pointsToReward').textContent = pointsToNext;

      // Progress bar
      const progressPercent = ((member.points % 50) / 50) * 100;
      document.getElementById('progressBar').style.width = progressPercent + '%';

      // Reward message
      const currentLevel = Math.floor(member.points / 50);
      const nextLevel = currentLevel + 1;
      document.getElementById('rewardMessage').textContent =
        `Level ${currentLevel} ‚Üí ${pointsToNext} points to Level ${nextLevel}!`;

      // Member Info
      document.getElementById('memberPhone').textContent = member.phone;
      document.getElementById('userId').textContent = userProfile.userId.substring(0, 20) + '...';

      if (member.email) {
        document.getElementById('emailRow').style.display = 'flex';
        document.getElementById('memberEmail').textContent = member.email;
      }

      const memberSince = new Date(member.created_at).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      document.getElementById('memberSince').textContent = memberSince;
      
      debugLog('‚úÖ Dashboard rendered successfully!');
    }

    function showError(message) {
      document.getElementById('loadingMessage').style.display = 'none';
      const container = document.querySelector('.container');
      const debugDiv = document.getElementById('debugLog');
      
      container.innerHTML = debugDiv.outerHTML + `
        <div class="error">
          ‚ùå ${message}
        </div>
        <button class="btn" onclick="closeLIFF()" style="background: #6c757d;">Close</button>
      `;
    }

    function openMenu() {
      debugLog('üç£ Opening menu...');
      window.location.href = '/liff-app.html';
    }

    function closeLIFF() {
      debugLog('üëã Closing LIFF...');
      liff.closeWindow();
    }
  </script>
</body>

</html>
